<form method="POST" id="opgaveform" action="/opgave">
    <h1 id="overskrift">Opret ny opgave</h1>
    <div class="row">
        {{!-- col 1 --}}
        <div class="col">
            <div class="form-group row">
                <label for="opgaveNavn" class="col-sm-3 col-form-label">Opgavens navn</label>
                <div class="col-sm-5">
                    <input type="text" class="form-control" id="opgaveNavn" name="opgaveNavn">
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="kundeId">Kunde</label>
                <div class="col-sm-5">
                    <select name="kundeId" form="opgaveform" class="form-control">
                        <option value=null></option>
                        {{#each kunde}}
                        <option value={{this.kundeId}}>{{this.fornavn}} {{this.efternavn}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="kundeansvarligId">Kundeansvarlig</label>
                <div class="col-sm-5">
                    <select name="kundeansvarligId" form="opgaveform" class="form-control">
                        <option value=null></option>
                        {{#each kundeansvarlig}}
                        <option value={{this.kundeansvarligId}}>{{this.fornavn}} {{this.efternavn}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="opgavestillerId">Opgavestiller</label>
                <div class="col-sm-5">
                    <select name="opgavestillerId" form="opgaveform" class="form-control">
                        <option value=null></option>
                        {{#each opgavestiller}}
                        <option value={{this.opgavestillerId}}>{{this.fornavn}} {{this.efternavn}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="lokationId">Lokation</label>
                <div class="col-sm-5">
                    <select name="lokationId" form="opgaveform">
                        <option value=null></option>
                        {{#each lokation}}
                        <option value={{this.lokationId}}>{{this.lokationNavn}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="opgavetypeId">Opgave type</label>
                <div class="col-sm-5">
                    <select name="opgavetypeId" form="opgaveform">
                        <option value=null></option>
                        {{#each opgavetype}}
                        <option value={{this.opgavetypeId}}>{{this.opgavetypeNavn}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="startDato">Start dato</label>
                <div class="col-sm-5">
                    <input type="date" class="form-control" id="startDato" name="startDato" value="null">
                    <div class="form-check">
                        <input type="hidden" form="opgaveform" name="fixedStartDato" value="0">
                        <input class="form-check-input" form="opgaveform" type="checkbox" id="fixedStartDato" value="0">
                        <label class="form-check-label" for="fixedStartDato">
                            Fixed start dato
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="slutDato">Slut dato</label>
                <div class="col-sm-5">
                    <input type="date" class="form-control" id="slutDato" name="slutDato" value="null">
                    <div class="form-check">
                        <input type="hidden" form="opgaveform" name="fixedSlutDato" value="0">
                        <input class="form-check-input" form="opgaveform" type="checkbox" id="fixedSlutDato" value="0">
                        <label class="form-check-label" for="fixedSlutDato">
                            Fixed slut dato
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="opgaveStatusId">Opgave status</label>
                <div class="col-sm-5">
                    <select name="opgaveStatusId" form="opgaveform">
                        <option value=null></option>
                        {{#each opgavestatus}}
                        <option value={{this.opgaveStatusId}}>{{this.opgaveStatusNavn}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="kontraktStatusId">Kontrakt status</label>
                <div class="col-sm-5">
                    <select name="kontraktStatusId" form="opgaveform">
                        <option value=null></option>
                        {{#each kontraktstatus}}
                        <option value={{this.kontraktStatusId}}>{{this.kontraktStatusNavn}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="estimeretTimetal">Estimeret timetal</label>
                <div class="col-sm-5">
                    <input type="number" class="form-control" id="estimeretTimetal" name="estimeretTimetal" value="0">
                </div>
            </div>
            {{#if opgaveInfo}}
        
            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="bemandedeTimer">Bemandede timer</label>
                <div class="col-sm-5">
                    <input type="number" class="form-control" id="bemandedeTimer" name="bemandedeTimer" disabled value="{{bemandetTimerTotal.timeAntal}}">
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="manglendeTimer">Manglende timer</label>
                <div class="col-sm-5">
                    <input type="number" class="form-control" id="manglendeTimer" name="manglendeTimer" disabled value="">
                </div>
            </div>
            {{/if}}

            {{!-- <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="aktiv">Aktiv opgave</label>
                <div class="col-sm-5">
                    <input type="checkbox" class="form-control" id="aktiv" name="aktiv">
                </div>
            </div> --}}
            <div class="formArea">
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="deadlineDato">Deadline dato</label>
                    <div class="col-sm-5">
                        <input type="date" class="form-control" id="deadlineDato">
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="deadlineKommentar">deadlineKommentar</label>
                    <div class="col-sm-5">
                        <input type="text" class="form-control" id="deadlineKommentar">

                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 col-form-label"></label>
                    <div class="col-sm-5">
                        <button type="button" id="addDeadline">Tilføj deadline</button>
                    </div>
                </div>
            </div>
            

            <div class="form-check">
                <input type="hidden" form="opgaveform" name="aktiv" value="0">
                <input class="form-check-input" form="opgaveform" type="checkbox" id="aktiv" value="0">
                <label class="form-check-label" for="aktiv">
                    Opgave er aktiv
                </label>
            </div>

            <div class="form-group row submitButton">
                <button type="button" id="submitCreate" class="btn btn-success">Opret Opgave</button>
                <button type="button" id="submitUpdate" class="btn btn-success">Opdater Opgave</button>
                <button type="button" id="submitDelete" class="btn btn-success">Slet Opgave</button>
            </div>

        </div>

        {{!-- col 2 --}}
        <div class="col">
            {{!-- <div class="muligeOpgavelosere">
                <div class="form-group row">
                    <h2>Mulige opgaveløsere</h2>
                </div>
                <div class="form-control row">
                    <div>
                        <table class="table table-light" id="muligeOpgavelosere" style="max-height: 300px">
                            <thead>
                                <tr>
                                    <th scope="col">Navn</th>
                                    <th scope="col">Konsulentprofil</th>
                                    <th scope="col">Lokation</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each muligeOpgaveloser}}
                                <tr id="opgaveloserRow" class="muligOpgaveloser">
                                    <input type="hidden" id="{{@index}}" idName="opgaveloserKonsulentProfilId" value={{this.opgaveloserKonsulentProfilId}}>
        
                                    <td value={{this.opgaveloserId}}>{{this.fornavn}} {{this.efternavn}}</td>
                                    <td value={{this.konsulentProfilId}}>{{this.konsulentProfilNavn}}</td>
                                    <td value={{this.lokationId}}>{{this.lokationNavn}}</td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> --}}
            

            <div class="form-group row">
                <h2>Deadlines</h2>
            </div>
            <div class="form-control row">
                <table class="table table-light" id="deadlines" style="max-height: 300px">
                    <thead>
                        <tr>
                            <th scope="col">Dato</th>
                            <th scope="col">Kommentar</th>
                            {{!-- <th scope="col">Status</th> --}}
                        </tr>
                    </thead>
                    <tbody>
                        {{#each deadlines}}
                        <tr onclick="markForRemoval(this)" value="{{this.deadlineId}}" class="pointer">
                            {{!-- <input type="hidden" class="deadlineDato" name="deadlines[{{@index}}][deadlineDato]" value="{{this.deadlineDato}}">
                            <input type="hidden" name="deadlines[{{@index}}][deadlineKommentar]" value="{{this.deadlineKommentar}}"> --}}
                            <td class="date">{{this.deadlineDato}}</td>
                            <td>{{this.deadlineKommentar}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
            <div class="form-group row">
                <button type="button" onclick="removeDeadlines()">Fjern valgte deadlines</button>
            </div>
        </div>

        {{!-- col 3 --}}
        <div class="col">
            {{#if opgaveInfo}}
            <div class="form-group row">
                <h2>Valgte opgaveløsere</h2>
            </div>
            <div class="form-control row">
                <div>
                    <table class="table table-light" id="valgteOpgavelosere">
                        <thead>
                            <tr>
                                {{!-- <th scope="col">Id</th> --}}
                                <th scope="col">Navn</th>
                                <th scope="col">Konsulentprofil</th>
                                <th scope="col">Lokation</th>
                                {{!-- <th scope="col">Status</th> --}}
                            </tr>
                        </thead>
                        <tbody class="pointer">
                            {{#each opgavelosere}}
                            <tr id="opgaveloserRow">
                                {{!-- <input type="hidden" name="opgaveloser[{{@index}}][opgaveloserKonsulentProfilId]" value={{this.opgaveloserKonsulentProfilId}}> --}}
                                <td value="{{this.opgaveloserId}}">{{this.fornavn}} {{this.efternavn}}</td>
                                <td value="{{this.konsulentProfilId}}">{{this.konsulentProfilNavn}}</td>
                                <td value="{{this.lokationId}}">{{this.lokationNavn}}</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>

                </div>
            </div>
            
            <div class="form-group row">
                <button type="button" id="redigerOpgavelosere">Rediger opgaveløsere</button>
            </div>
            {{/if}}
            <div class="form-group row">
                <h2>Kommentar</h2>
            </div>
            <div class="form-control row">
                <textarea class="form-control" form="opgaveform" name="kommentar" id="kommentar" wrap="soft" rows="5"
                    value=""></textarea>
                {{!-- <input type="textarea" class="form-control" id="kommentar" name="kommentar" rows="3"> --}}
            </div>
            
        </div>
        


    </div>
</form>

<script src="/js/clientopgave.js"></script>


<button id="testbutton">SET TEST VALUES</button>
<script>
    $(document).ready(function () {
        $('#testbutton').click(function () {
            $('select').each(function () {//set all dropdowns
                $(this).val($(this).children("option:last").val())
            })

            $('input[type="text"],textarea').each(function () {//set all text boxes
                $(this).val('some text')
            })

            $('input[type="date"]').each(function () {//all dates
                $(this).val('2019-10-10')
            })

            $('#estimeretTimetal').val(100)
        })

        //hvis det er en bestemt opgave ligesom - http://localhost:3000/opgave?opgaveId=1
        //console.log(JSON.parse({{opgaveInfo}}))
        {{#if opgaveInfo}}
        function makeDate(date) {
            var d = new Date(date)
            var year = d.getFullYear()
            var month = d.getMonth() + 1
            var day = d.getDate()

            if (month < 10)
                month = '0' + month
            if (day < 10)
                day = '0' + day

            return year + '-' + month + '-' + day
        }
        var startDato = new Date("{{opgaveInfo.startDato}}")
        var slutDato = new Date("{{opgaveInfo.slutDato}}")
        $('#startDato').val(makeDate(startDato))
        $('#slutDato').val(makeDate(slutDato))

        function setAllValues() {
            $('#submitCreate').remove()
            //$('.submitButton').append('<button type="button" id="submitUpdate" class="btn btn-success">Opdater Opgave</button>')
            //$('.submitButton').append('<button type="button" id="submitDelete" class="btn btn-success">Slet Opgave</button>')

            $('form').attr('method', "PUT")
            $('#overskrift').text('Rediger Opgave')

            $('input[name="opgaveNavn"]').val("{{opgaveInfo.opgaveNavn}}")

            $('select[name="kundeId"]').val("{{opgaveInfo.kundeId}}")
            $('select[name="kundeansvarligId"]').val("{{opgaveInfo.kundeansvarligId}}")
            $('select[name="opgavestillerId"]').val("{{opgaveInfo.opgavestillerId}}")
            $('select[name="lokationId"]').val("{{opgaveInfo.lokationId}}")
            $('select[name="opgavetypeId"]').val("{{opgaveInfo.opgavetypeId}}")
            $('select[name="opgaveStatusId"]').val("{{opgaveInfo.opgaveStatusId}}")
            $('select[name="kontraktStatusId"]').val("{{opgaveInfo.kontraktStatusId}}")

            $('input[name="fixedStartDato"]').val("{{opgaveInfo.fixedStartDato}}")
            if ("{{opgaveInfo.fixedStartDato}}" == '1')
                $('#fixedStartDato')[0].checked = true

            $('input[name="fixedSlutDato"]').val("{{opgaveInfo.fixedSlutDato}}")
            if ("{{opgaveInfo.fixedSlutDato}}" == '1')
                $('#fixedSlutDato')[0].checked = true

            $('input[name="aktiv"]').val("{{opgaveInfo.aktiv}}")
            if ("{{opgaveInfo.aktiv}}" == '1')
                $('#aktiv')[0].checked = true

            $('input[name="estimeretTimetal"]').val("{{opgaveInfo.estimeretTimetal}}")

            {{#if bemandetTimerTotal.timeAntal}}
                let manglende = {{opgaveInfo.estimeretTimetal}} - {{bemandetTimerTotal.timeAntal}}
                $('input[name="manglendeTimer"]').val(manglende)
            {{/if}}

            $('textarea[name="kommentar"]').val("{{opgaveInfo.kommentar}}")

            $('<input>', {
                type:"hidden",
                id:"opgaveId",
                name:"opgaveId",
                value:"{{opgaveInfo.opgaveId}}"
            }).appendTo('form');

            $('.muligeOpgavelosere').remove()

            $('#deadlines tr').each(function () {
                $(this).children('.date').text(makeDate($(this).children('.date').text()))
                $(this).children('.deadlineDato').val(makeDate($(this).children('.date').text()))
            })


        }
        setAllValues()
        {{else}}
        $('#submitUpdate').remove()
        $('#submitDelete').remove()
        {{/if}}
    })

</script>